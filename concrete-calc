#!/bin/bash

set -euo pipefail

#!/bin/bash

# Constants
KG_TO_LBS=66.138678655
WATER_PER_KG_L=2.7
WATER_PER_LBS_ML=$(echo "scale=4; $WATER_PER_KG_L * 1000 / $KG_TO_LBS" | bc)
URL_TECH_SPEC="https://www.sakrete.com/wp-content/uploads/2024/01/Sakrete-High-Strength-Concrete-Mix-TDS.pdf"
URL_ORDER="https://www.homedepot.ca/product/quikrete-ready-to-use-concrete-mix-30kg/1000149580"

# Function to calculate water from pounds
pounds_to_water() {
    local pounds="$1"
    local water_ml=$(echo "scale=2; $pounds * $WATER_PER_LBS_ML" | bc)
    echo "Water needed for $pounds lbs of mix: $water_ml mL"
}

# Function to calculate pounds from water
water_to_pounds() {
    local water_ml="$1"
    local pounds=$(echo "scale=2; $water_ml / $WATER_PER_LBS_ML" | bc)
    echo "Mix needed for $water_ml mL of water: $pounds lbs"
}

# Function to open URLs
open_url() {
    local url="$1"
    if command -v xdg-open &> /dev/null; then
        xdg-open "$url" 2>/dev/null
    elif command -v open &> /dev/null; then
        open "$url" 2>/dev/null
    elif command -v start &> /dev/null; then
        start "$url" 2>/dev/null
    else
        echo "Please open this URL manually: $url"
    fi
}

# Function for interactive mode
interactive_mode() {
    while true; do
        echo ""
        echo "====================================="
        echo "  SAKRETE Concrete Mix Calculator"
        echo "====================================="
        echo "1. Calculate water from mix (lbs → mL)"
        echo "2. Calculate mix from water (mL → lbs)"
        echo "3. View Technical Data Sheet"
        echo "4. ORDER MORE"
        echo "5. Exit"
        echo "====================================="
        read -p "Enter your choice (1-5): " choice
        
        case $choice in
            1)
                read -p "Enter mix weight in pounds: " pounds
                if [[ $pounds =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
                    pounds_to_water "$pounds"
                else
                    echo "Error: Please enter a valid number"
                fi
                ;;
            2)
                read -p "Enter water volume in milliliters: " water_ml
                if [[ $water_ml =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
                    water_to_pounds "$water_ml"
                else
                    echo "Error: Please enter a valid number"
                fi
                ;;
            3)
                echo "Opening Technical Data Sheet..."
                open_url "$URL_TECH_SPEC"
                ;;
            4)
                echo "Opening Home Depot ordering page..."
                open_url "$URL_ORDER"
                ;;
            5)
                echo "Goodbye!"
                exit 0
                ;;
            *)
                echo "Invalid choice. Please enter 1-5."
                ;;
        esac
        
        read -p "Press Enter to continue..."
    done
}

# Function for non-interactive mode
non_interactive_mode() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -w|--water)
                if [[ -n "$2" && "$2" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
                    pounds_to_water "$2"
                    shift 2
                else
                    echo "Error: -w requires a numeric argument"
                    exit 1
                fi
                ;;
            -m|--mix)
                if [[ -n "$2" && "$2" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
                    water_to_pounds "$2"
                    shift 2
                else
                    echo "Error: -m requires a numeric argument"
                    exit 1
                fi
                ;;
            --tech-spec)
                open_url "$URL_TECH_SPEC"
                shift
                ;;
            --order)
                open_url "$URL_ORDER"
                shift
                ;;
            -h|--help)
                echo "Usage: $0 [OPTION]"
                echo ""
                echo "Options:"
                echo "  -w, --water POUNDS    Calculate water needed for POUNDS of mix"
                echo "  -m, --mix MILLILITERS Calculate mix needed for MILLILITERS of water"
                echo "  --tech-spec           Open technical data sheet"
                echo "  --order               Open Home Depot ordering page"
                echo "  -h, --help            Show this help message"
                echo ""
                echo "If no arguments are provided, interactive mode is started."
                exit 0
                ;;
            *)
                echo "Unknown option: $1"
                echo "Use -h or --help for usage information"
                exit 1
                ;;
        esac
    done
}

# Main execution
if [[ $# -eq 0 ]]; then
    interactive_mode
else
    non_interactive_mode "$@"
fi
