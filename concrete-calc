#!/usr/bin/env bash

# Concrete Water-Cement Ratio Calculator
# Interactive script for calculating water or cement amounts

set -euo pipefail

# Configuration
DEFAULT_RATIO="0.45"  # Common water-to-cement ratio for general use
MAX_RATIO="0.70"      # Maximum ratio (slurry)
MIN_RATIO="0.25"      # Minimum ratio (unworkable without plasticizer)

# Colors for better UX
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print headers
print_header() {
    echo -e "${BLUE}"
    echo "╔══════════════════════════════════════════════════╗"
    echo "║   Concrete Water-Cement Ratio Calculator         ║"
    echo "╚══════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Function to display ratio guidance
show_ratio_guide() {
    echo -e "${YELLOW}"
    echo "╔══════════════════════════════════════════════════╗"
    echo "║              Water-Cement Ratio Guide            ║"
    echo "╠══════════════════════════════════════════════════╣"
    echo "║ 0.25-0.35 : Very high strength (with plasticizer)║"
    echo "║ 0.40-0.45 : Structural concrete                  ║"
    echo "║ 0.50-0.55 : General purpose, workable            ║"
    echo "║ 0.60-0.70 : Wet mix, slurry, non-structural      ║"
    echo "╚══════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Function to validate numeric input
validate_number() {
    local num="$1"
    if [[ ! "$num" =~ ^[0-9]+(\.[0-9]+)?$ ]] || [[ $(echo "$num <= 0" | bc -l 2>/dev/null) -eq 1 ]]; then
        echo -e "${RED}Error: Please enter a positive number${NC}"
        return 1
    fi
    return 0
}

# Function to validate ratio input
validate_ratio() {
    local ratio="$1"
    if [[ ! "$ratio" =~ ^[0-9]+\.[0-9]+$ ]] || \
       [[ $(echo "$ratio < $MIN_RATIO || $ratio > $MAX_RATIO" | bc -l 2>/dev/null) -eq 1 ]]; then
        echo -e "${RED}Error: Ratio must be between $MIN_RATIO and $MAX_RATIO${NC}"
        return 1
    fi
    return 0
}

# Function to calculate water from cement
calculate_water() {
    local cement="$1"
    local ratio="$2"
    local unit="$3"
    
    # Calculate water
    water=$(echo "$cement * $ratio" | bc -l)
    
    # Round to 2 decimal places
    water_rounded=$(printf "%.2f" "$water")
    
    echo -e "\n${GREEN}══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}Results:${NC}"
    echo -e "${GREEN}══════════════════════════════════════════════════${NC}"
    echo -e "Cement: ${YELLOW}$cement $unit${NC}"
    echo -e "Water-Cement Ratio: ${YELLOW}$ratio${NC}"
    echo -e "Water Required: ${YELLOW}$water_rounded $unit${NC}"
    
    # Calculate in liters if kg (since 1kg water ≈ 1 liter)
    if [[ "$unit" == "kg" ]]; then
        echo -e "Water Volume: ${YELLOW}$water_rounded liters${NC}"
    fi
    
    # Display mix consistency
    if [[ $(echo "$ratio < 0.35" | bc -l) -eq 1 ]]; then
        echo -e "Mix Consistency: ${YELLOW}Very stiff (needs plasticizer)${NC}"
    elif [[ $(echo "$ratio <= 0.45" | bc -l) -eq 1 ]]; then
        echo -e "Mix Consistency: ${YELLOW}Stiff / Structural${NC}"
    elif [[ $(echo "$ratio <= 0.55" | bc -l) -eq 1 ]]; then
        echo -e "Mix Consistency: ${YELLOW}Workable / General purpose${NC}"
    else
        echo -e "Mix Consistency: ${YELLOW}Wet / Slurry${NC}"
    fi
}

# Function to calculate cement from water
calculate_cement() {
    local water="$1"
    local ratio="$2"
    local unit="$3"
    
    # Calculate cement
    cement=$(echo "$water / $ratio" | bc -l)
    
    # Round to 2 decimal places
    cement_rounded=$(printf "%.2f" "$cement")
    
    echo -e "\n${GREEN}══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}Results:${NC}"
    echo -e "${GREEN}══════════════════════════════════════════════════${NC}"
    echo -e "Water Available: ${YELLOW}$water $unit${NC}"
    echo -e "Water-Cement Ratio: ${YELLOW}$ratio${NC}"
    echo -e "Cement Required: ${YELLOW}$cement_rounded $unit${NC}"
    
    # Display mix warning if ratio is extreme
    if [[ $(echo "$ratio > 0.6" | bc -l) -eq 1 ]]; then
        echo -e "${RED}Warning: High ratio produces weak concrete${NC}"
    elif [[ $(echo "$ratio < 0.35" | bc -l) -eq 1 ]]; then
        echo -e "${YELLOW}Note: Low ratio may be unworkable without additives${NC}"
    fi
}

# Function to show quick reference table
show_quick_reference() {
    echo -e "\n${YELLOW}Quick Reference (for 50kg cement bag):${NC}"
    echo "┌─────────────────┬───────────────┐"
    echo "│ Water:Cement    │ Water Needed  │"
    echo "├─────────────────┼───────────────┤"
    echo "│     0.40        │    20.0 L     │"
    echo "│     0.45        │    22.5 L     │"
    echo "│     0.50        │    25.0 L     │"
    echo "│     0.55        │    27.5 L     │"
    echo "│     0.60        │    30.0 L     │"
    echo "└─────────────────┴───────────────┘"
}

# Main interactive menu
main_menu() {
    while true; do
        clear
        print_header
        
        echo -e "${YELLOW}Select calculation type:${NC}"
        echo "1) Calculate water needed for given cement"
        echo "2) Calculate cement needed for given water"
        echo "3) View ratio guide and recommendations"
        echo "4) Quick reference table"
        echo "5) Exit"
        echo ""
        
        read -rp "Enter your choice (1-5): " choice
        
        case $choice in
            1)
                clear
                print_header
                show_ratio_guide
                
                # Get cement amount
                while true; do
                    read -rp "Enter cement amount (e.g., 50): " cement_amount
                    if validate_number "$cement_amount"; then
                        break
                    fi
                done
                
                # Get units
                echo -e "\nSelect units:"
                echo "1) Kilograms (kg)"
                echo "2) Pounds (lbs)"
                read -rp "Enter unit choice (1-2): " unit_choice
                
                case $unit_choice in
                    1) unit="kg" ;;
                    2) unit="lbs" ;;
                    *) 
                        echo -e "${RED}Invalid choice, defaulting to kg${NC}"
                        unit="kg"
                        ;;
                esac
                
                # Get ratio
                while true; do
                    read -rp "Enter water-cement ratio [Default: $DEFAULT_RATIO]: " ratio_input
                    if [[ -z "$ratio_input" ]]; then
                        ratio_input="$DEFAULT_RATIO"
                    fi
                    if validate_ratio "$ratio_input"; then
                        break
                    fi
                done
                
                calculate_water "$cement_amount" "$ratio_input" "$unit"
                ;;
                
            2)
                clear
                print_header
                show_ratio_guide
                
                # Get water amount
                while true; do
                    read -rp "Enter water amount (e.g., 22.5): " water_amount
                    if validate_number "$water_amount"; then
                        break
                    fi
                done
                
                # Get units
                echo -e "\nSelect units:"
                echo "1) Liters (L)"
                echo "2) Gallons (gal)"
                read -rp "Enter unit choice (1-2): " unit_choice
                
                case $unit_choice in
                    1) unit="L" ;;
                    2) unit="gal" ;;
                    *) 
                        echo -e "${RED}Invalid choice, defaulting to liters${NC}"
                        unit="L"
                        ;;
                esac
                
                # Get ratio
                while true; do
                    read -rp "Enter water-cement ratio [Default: $DEFAULT_RATIO]: " ratio_input
                    if [[ -z "$ratio_input" ]]; then
                        ratio_input="$DEFAULT_RATIO"
                    fi
                    if validate_ratio "$ratio_input"; then
                        break
                    fi
                done
                
                calculate_cement "$water_amount" "$ratio_input" "$unit"
                ;;
                
            3)
                clear
                print_header
                show_ratio_guide
                
                echo -e "\n${GREEN}Recommendations:${NC}"
                echo "• Structural work: 0.40-0.45"
                echo "• Foundations: 0.45-0.50"
                echo "• Non-structural: 0.50-0.60"
                echo "• Mortar/Plaster: 0.60-0.70"
                echo ""
                echo "${YELLOW}Note: Lower ratios = stronger but less workable${NC}"
                ;;
                
            4)
                clear
                print_header
                show_quick_reference
                ;;
                
            5)
                echo -e "\n${GREEN}Exiting. Good luck with your concrete project!${NC}"
                exit 0
                ;;
                
            *)
                echo -e "${RED}Invalid choice. Please try again.${NC}"
                ;;
        esac
        
        # Pause before returning to menu
        echo -e "\n${BLUE}Press Enter to continue...${NC}"
        read -r
    done
}

# Check if bc calculator is installed
if ! command -v bc &> /dev/null; then
    echo -e "${RED}Error: 'bc' calculator is required but not installed.${NC}"
    echo "Install it with:"
    echo "  Ubuntu/Debian: sudo apt install bc"
    echo "  macOS: brew install bc"
    echo "  CentOS/RHEL: sudo yum install bc"
    exit 1
fi

# Run main menu
main_menu
